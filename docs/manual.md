# ISUCON10 本選当日マニュアル

## 課題アプリケーション XSUCON について

20XX 年、人類はオーガナイザー X41 氏の主催するパフォーマンスチューニングコンテスト「XSUCON」に夢中になっていた。しかし開催直前となったある日、最新版の XSUCON ポータルサイトにはパフォーマンスに問題があることが発覚。このままでは多くの人にとって不満の残る大会になってしまうだろう。あなたは XSUCON 運営チームの一人としてパフォーマンスを改善しつつ、また大会を大いに盛り上げ、選手およびオーディエンスを満足させなければならない。

### 課題アプリケーション仕様

課題アプリケーション XSUCON の仕様については、こちらを参照してください。
★ https://hackmd.io/Ip71mfq8TH2fECehU8RaTg

## ISUCON10 本選 ポータルサイト

ISUCON10 本選の競技 (実競技) は下記ポータルサイトを利用します。
事前に登録した情報を用いてログインしてください。
なお、このページは実競技開始時刻までアクセスすることはできません。

ポータルサイトでは、実ベンチマークの実行・結果確認、質問/サポート依頼の送信、実リーダーボードの確認ができます。

https://portal.isucon.net/contestant

### Discord の利用について

ISUCON 10 サポート Discord サーバは競技時間前後はすべてのチャンネルが発言不可となります。
ポータルサイトを通して質問やサポート依頼を送信することができますので、そちらを利用してください。

ただし、選手は Discord の確認が可能な状態、通知が受け取れる状態を維持してください。
これはポータルで送信した質問/サポート依頼の内容を運営が確認した上で、リアルタイムでのチャットが必要だと判断した場合、こちらから Discord 上でプライベートチャンネルを作成し、mention の上よびかけを行う場合があるためです。

また、アナウンス等も Discord で実施されます。

## サーバ、ネットワーク構成について

事前に用意されたサーバは ★ 台あり、これらのサーバに SSH を用いて接続し競技を行います。
ポータル右上に表示されているチーム ID を元に、以下の gist より割り当てられている「踏み台用 IP アドレス」と「チームサブネット」を確認してください。

https://gist.github.com/whywaita/★

競技に用いる ★ 台のサーバはチームのサブネットに対してそれぞれ 101 ~ 103 が第 4 オクテットとなります。具体的な IP アドレスはポータルにて確認することができます。

上記のサーバに接続するために踏み台を経由して SSH 接続を行います。
[ssh_config(5)](https://man.openbsd.org/ssh_config.5) の例を以下に示します。なお、あくまで例示であり必ず以下の設定を利用する必要はありません。

```
 Host isucon-bastion
   HostName <踏み台用IPアドレス>
   Port 20340
   User isucon

 Host isucon-server
   ProxyJump isucon-bastion
   User isucon
   HostName <自チームサーバのIPアドレス>
```

なお、踏み台用のサーバはポート番号 `★` でログインすることができます。

### 重要事項

**競技終了後は、ベンチマーク走行成績の追試を行いますので、Discord サーバ および http://isucon.net/ にて運営からお知らせをするまで、サーバの操作はしないでください** (競技終了後の作業は禁止行為にあたります)。お知らせは当日夜あるいは翌日夜までに行います。

**競技に利用できる計算機資源は主催者側が指定した ★ 台までのインスタンスのみです。** 外部のメトリクス計測サービスの使用のみ特例として許可しますが、スコアを向上させるいかなる効果も持つものであってはいけません。

## 作業手順

以下の順序で作業を開始してください。

### 1. サーバーへのログイン

上記に記載したサーバーに対して SSH 接続してください。
ログインには参加登録に利用した ( = ポータルのログインに利用している) GitHub アカウントに登録されている SSH 公開鍵を利用します。

SSH ログインのユーザ名は `isucon` です。

**［重要］`isucon` ユーザーの以外のアカウントに関して、アカウントの削除や既存の公開鍵の削除を行ったことにより主催者による追試をおこなうことができない場合は、失格とします。**

### 2. アプリケーションの動作確認

ブラウザからアクセスするとアプリが表示されます。
踏み台を経由したブラウザアクセスには、 [SSH におけるローカルポートフォワーディング](https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding#Local_Port_Forwarding) などを用いて表示することができます。
これ以外の方法で動作確認してもかまいません。

以下に Team001 におけるローカルポートフォワーディングを実行するコマンドを例示します。
これは「リモートホスト `isucon-server` に SSH 接続をした上で」「ローカルの `localhost:10443` への TCP 接続を」「リモートホストを通して `10.160.1.101:443` へ転送する」というコマンドです。

```shell
$ ssh -L localhost:10443:10.160.1.101:443 isucon-server
```

サーバーへ配置されている TLS 証明書の subject name は `*.t.isucon.dev` となっています。 `*.t.isucon.dev` の DNS レコードは `127.0.0.1`, `::1` が設定されているため、 `t.isucon.dev` のサブドメインを利用して localhost のポートへアクセスすることで、TLS 証明書検証エラーを回避することができます。

以上を踏まえると、上記のコマンド例を実行している場合、 https://xsuportal.t.isucon.dev:10443 でアプリケーションへアクセスすることができます。

### 3. 負荷走行 (ベンチマーク)

負荷走行はポータルサイト上からリクエストします。
ポータルサイトの [競技参加者向けページ](https://portal.isucon.net/contestant) にアクセスし、 "Job Enqueue Form" から負荷走行対象のサーバーを選択、"Enqueue" をクリックで実行が開始されます。

なお、負荷走行が待機中もしくは実行中の間は追加の Enqueue を行うことはできません。

### 参考実装

参考実装として下記の言語が提供されています。 ★

- Go
- Ruby
- PHP
- Rust
- Node.js

### 参考実装の切り替え方法

初期状態では Ruby による実装が起動している状態になります。

各言語実装は systemd で管理されています。
例えば、参考実装を Ruby から PHP に切り替えるには次のようにします。

```shell
sudo systemctl disable --now xsuportal-web-ruby.service
sudo systemctl disable --now xsuportal-api-ruby.service

sudo systemctl enable --now xsuportal-web-php.service
sudo systemctl enable --now xsuportal-api-php.service
```

## 負荷走行について

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize` （20 秒以内）
2. 負荷走行 （60 秒）
3. 待ち時間 （5 秒）
4. 整合性チェック （数秒〜数十秒）

初期化処理は 20 秒以内に完了する必要があります。これを超えた場合、負荷走行は失敗になります。

ベンチマーカーは負荷走行終了ののち、5 秒待ってから整合性チェックを行います。
ジョブキューによる遅延処理等を追加した場合は、このタイミングまでに処理の整合性をとってください。

負荷走行終了後、5 秒経ってもレスポンスが返ってきていないリクエストはすべて強制的に切断され、後述のスコア計算方法に従いタイムアウトとして数えられます。

### キャッシュについて

- `GET /api/audience/dashboard`
  - アプリケーションは、データの更新から最大 1 秒古い情報を返すことができます。ただし、ベンチマーカーが検知しない限りはそれより古い情報を返してもよく、違反にはなりません。
- 上記以外の HTTP リクエスト
  - データの更新が即時反映されていることを期待して実ベンチマーカーは検証を行います。ただし、ベンチマーカーが検知しない限りは古い情報を返してもよく、違反にはなりません。

実ベンチマーカーは一般的なブラウザの挙動を模した [Conditional GET](https://tools.ietf.org/html/rfc7232) に対応しています。アプリケーションは、 `Cache-Control` やその他必要なレスポンスヘッダを返すことで、ベンチマーカーから Conditional GET リクエストを受けることができます。データが更新されていないことが期待されるリクエストにおいては、`304 Not Modified` を返したり、あるいはブラウザのキャッシュ有効期限の制御によってリクエストが発生していなかったりしても、ベンチマーカーはそれを 1 レスポンスとして扱い、スコアは通常通り加算されます。 なお、ベンチマーカーのエージェントはそれぞれが独立したブラウザであるため、 `Cache-Control: public` が指定されていたとしても、エージェント同士でキャッシュを共有することはありません。つまり仮想選手の間でブラウザキャッシュが使い回されることはありません。

### タイムアウトについて

- 仮想ポータル
  - `POST /initialize`
    - 20 秒以内にレスポンスを返す必要があります。これを超えた場合、負荷走行は即時失敗します。
  - `GET /api/contestant/dashboard`, `GET /api/audience/dashboard`
    - 2 秒以内にレスポンスを返す必要があります。これを超えた場合、後述のスコア計算に従い減点の対象となります。
  - 上記以外の HTTP リクエスト
    - 10 秒以内にレスポンスを返す必要があります。これを超えた場合、後述のスコア計算に従い減点の対象となります。
- 仮想ベンチマークサーバ
  - タイムアウトは規定しません。

## スコア計算

負荷走行のスコアは以下の計算式によって算出されます。

```
スコア = (仮想選手スコア * 大会規模ボーナス) + 仮想オーディエンススコア - 減点
```

- 仮想競技者スコア
  - 仮想負荷走行が 1 回完了する （10 点）
  - 仮想選手の質問（Clarification）に対して仮想主催者から回答が行われたとき、その回答を仮想選手が表示する （10 点）
  - 仮想選手がダッシュボードを表示する (2 点)
- 大会規模ボーナス
  - 仮想選手の参加数によるボーナス （後述）
- 仮想オーディエンススコア
  - 仮想オーディエンスがダッシュボードを表示する (10 回ごとに 1 点)

大会規模ボーナスは、仮想コンテストに参加した仮想選手の数（team に所属している contestant の総数）によって、以下の表に従って算出されます。

| 参加した仮想選手の数 | 大会規模ボーナス（倍率） |
| -------------------- | ------------------------ |
| 1-59                 | 1.0                      |
| 60-119               | 1.2                      |
| 120-179              | 1.4                      |
| 180-239              | 1.6                      |
| 240-299              | 1.8                      |
| 300-                 | 2.0                      |

負荷走行時に発生するエラーによっては、減点されたり、即時失敗（fail）したりします。条件は以下の通りです。

- アプリケーション互換性チェックに失敗した場合や、その他ベンチマーカーに致命的と判断されたエラー
  - 1 回以上で即時失敗
- HTTP ステータスコードやレスポンス内容などに誤りがある
  - 1 回あたり減点 50 点
  - 100 回を越えたら即時失敗
- リクエストから 2 秒以内にレスポンスが返却されない（タイムアウト）
  - 100 回を越えたら 100 回あたり減点 100 点
  - 即時失敗は無し

計算の結果、スコアが 0 点になった場合は失敗として扱われます。

## リーダーボードの更新について

ポータルサイト上のリーダーボードのスコアは、競技終了前の 1 時間は表示は更新されなくなり、自チームのスコアのみ確認が可能になります。

## 特別賞

競技時間中のスコアが、最初に **15,000** を超えた 1 チームを特別賞とします。

## 最終スコア

競技時間終了後、**再起動後に主催者によって実行された負荷走行のスコア**を最終スコアとします。

### 競技時間終了後に主催者によって行う作業手順

1. 全チームのサーバーを再起動し、10 分以上待つ
2. 全チームのベンチマークを主催者用のポータルからエンキューし計測
   - これが成功していた場合、この計測結果を最終スコアとする
3. 2 での結果が fail となったチームのサーバーを再起動
4. 3 の対象となったチームのベンチマークを 2 同様にポータルからエンキューし計測（リトライ）
   - このとき fail となったチームは失格とする
   - 成功していた場合、この計測結果を最終スコアとする
5. 主催者は全チームのサーバーを再起動し、ブラウザから動作確認を行う
   - ここで正常な動作が確認できなかったチームは失格とする
6. 5 をパスしたチームの中からポータル上でのスコアを最終スコアとする

### 競技終了後の注意事項

- 主催者によるブラウザからの動作確認の際、主催者は `/initialize` は実行しないのでご注意ください。
- 競技時間終了後は、選手は競技サーバーにおいて一切の操作を行わないでください。

# 本選レギュレーション

## 連絡手段

参加登録時に主催者から案内するサポートチャット (Discord)、もしくは主催者が運営する Web サイト (ポータル等) を連絡手段とする。原則として競技中の質問・サポート対応はポータル、競技中および競技時間前後の全体アナウンスはサポートチャットを利用する。

全選手は必ずサポートチャットへログインし、通知等を設定するなど、連絡を確認できるようにすること。また、競技中はポータルサイトも確認すること。そして、主催者からの対応が必要な連絡に対し適切に対応しなかった場合、選手およびチームは円滑に競技へ参加できなくなる可能性について留意すること。

主催者は質問への対応等に際し、必要に応じてサポートチャットにおいて選手およびチームとチャットを開始する場合がある。その呼び掛けを行う際、主催者は Discord 上の mention 機能を利用する。

### 質問

選手は主催者へ質問を送信することができる。競技時間中は原則としてポータルから、競技前後はサポートチャットを利用する。質問は競技内容・マニュアル・レギュレーション等に対する疑問点・明確にしたい事項の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができるが、これに限らない。主催者は質問された内容について競技の一環である場合は、回答できない旨返答することがある。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答される。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開される。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できる。質問への回答/更新はポータルサイト上にて選手へ通知される。

主催者は競技時間中の質問への回答について、原則として全選手へ公開する。ただし、重複する質問や、選手およびチーム個別の問題 (サーバ障害など) に対する対応の場合、この限りではない。

## ソフトウェア事項

選手は主催者から Web アプリケーション (問題) が与えられ、選手は競技時間内にその Web アプリケーションの高速化を行う。選手は高速化された実装 (回答) を作成する時、主催者より与えられたソフトウェア (初期実装) をベースに実装しても良いし、しなくても良い。 どのプログラミング言語で初期実装が提供されるかは主催者は事前にアナウンスするが、その各々の性能が一致することは保証されない。

高速化の際、主催者より問題として与えられた Web アプリケーションから、以下の部分は変更しないこと。

- アクセス先の URI、ただしサーバー側で生成する部分（ID など）は文字種（[0-9] や [0-9a-zA-Z_] など）を変えない範囲で自由に生成しても良い
- レスポンス (HTML の DOM, JSON オブジェクト等) の構造（表示に影響しない範囲での空白文字の増減は許可される）
- JavaScript/CSS ファイルの内容
- 画像および動画等のメディアファイルの内容

各サーバにおけるソフトウェアの入れ替え、設定の変更、アプリケーションコードの変更および入れ替えなどは一切禁止しない。 ベンチマーク中にポータル・マニュアル・レギュレーションといった、主催の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。 ただしモニタリングやテスト、開発などにおいては、PC や外部のサーバーを利用しても構わない。

許可される事項には、例として以下のような作業が含まれる。

- 複数台あるサーバーの役割の変更
- DB スキーマの変更やインデックスの作成・削除
- データベースに利用するミドルウェアの変更
- キャッシュ機構の追加、ジョブキュー機構の追加による遅延書き込み
- Web Push 実装の追加（XSUCON アプリケーションマニュアルを参照）
- 他の言語による再実装

ただし以下の事項に留意すること。

- コンテスト進行用のメンテナンスコマンドが正常に動作するよう互換性を保つこと
- サーバ再起動後にすべてのアプリケーションコードが正常動作する状態を維持すること
- ベンチマーク実行時にアプリケーションに書き込まれたデータは再起動後にも取得できること

ソフトウェア事項の詳細は競技当日に主催者より公開されるマニュアル (当日マニュアル) に記載され、当日マニュアルに記載されている内容が本レギュレーションに記載されている内容より優先される。

## 禁止事項

以下の行為を特に禁止する。

- 競技終了時間までに、競技の内容に関するあらゆる事項 (問題内容・計測ツールの計測方法など)を公開・共有すること(内容を推察できる発言も含む)
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事 (結託行為) も禁止とする。
  - ただし主催者が Twitter, Web サイトにおいて公開している情報は除く。ポータルサイトにおけるログインを要するページにおいて記載されている内容は公開情報でない旨留意すること。
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為
- 主催者が競技に不必要とみなす競技環境からのネットワークアクセス
  - 競技に必要なネットワーク利用としては、主催者の指示 (レギュレーション, マニュアル等含む) で許可・想定されている行為、提供されたインスタンスの初期状態で利用可能なサービスや、外部のバージョン管理システム (GitHub 等)、ソフトウェアパッケージのリポジトリ (apt, yum リポジトリや、docker, npm, RubyGems レジストリ, proxy.golang.org 等) が例として挙げられる。
  - 一方、提供されたインスタンスからインターネットまでの経路上にあるホスト等、選手がその選手へ提供されていないホストについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為は、主催者により不必要と判断される場合がある。なお、例示のため、これに限らない。

本マニュアルにおいて禁止とされた行為 (禁止事項) への違反は、失格となる。
